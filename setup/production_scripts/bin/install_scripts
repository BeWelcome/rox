scripts_dir=/home/bwrox/bwrox.trunk/setup/production_scripts/
user=bwrox

error() { echo $1 >&2 ; exit 255 ; }

[ "$USER" == "$user" ] || error "script has to be run as user bwrox"

[ -d $scripts_dir ] || error "$scripts_dir not found"

cd $scripts_dir
echo "updating scripts"
svn up
. server_config.sh

# to avoid duplicates, delete eventual garbage files
find . '(' -name '*.pyc' -o -name '*~' -o -name '*.orig' -o -name '*~' ')' -a -exec 'rm' -f '{}' ';'

tmpfile="/tmp/new_bwrox_crontab.$$"
echo "## AUTOGENERATED CRONTAB.  Do not edit!  (Consult Tobias)" > $tmpfile
munin_plugins=""
for dir in $host_tags; do
  for file in `echo $scripts_dir/cron.d/$dir/*` ; do
   if [ -r "$file" ]; then
     echo "## BEGIN $file" >> $tmpfile
     cat $file >> $tmpfile
     echo "## END   $file" >> $tmpfile
     echo >> $tmpfile
   fi
  done
  for file in `echo $scripts_dir/munin-plugins.d/$dir/*` ; do
   if [ -r "$file" ]; then
        munin_plugins="$munin_plugins $file"
   fi
  done
done

echo "installing new crontab"
crontab -l > $HOME/crontab.old
cat $tmpfile | crontab -

echo "installing munint plugins"
cd /etc/munin/plugins
cd /etc/munin/plugins
find . -maxdepth 1 -lname "$scripts_dir/munin-plugins.d/*/*" -exec rm '{}' ';'
for plugin in $munin_plugins
do
  rm -f `/etc/munin/plugins/basename $plugin`
  ln -s $plugin .
done

sudo /etc/init.d/munin-node restart | grep -v starting | grep -v stopping

