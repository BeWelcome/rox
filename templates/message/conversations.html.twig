{% extends 'base.html.twig' %}
{% import 'macros.twig' as macros %}

{% block javascripts %}
    {{ encore_entry_script_tags('conversations') }}
    <script>
        $(window).on('load', function () {
            $('#checkAll').click(function () {
                $('input:checkbox.checkable').prop('checked', this.checked);
            });
        });
    </script>
{% endblock %}


{% block content %}
    {% set member = app.user %}
    <h2>{{ 'conversations' | trans }}</h2>
    <div class="row no-gutters">
        <div class="col-12 form-inline">
            <div class="custom-control custom-switch mr-1">
                <input type="checkbox" id="show_messages"
                       name="search[show_options]"
                       class="show_options custom-control-input" value="1"
                       {% if showMessages %}checked="checked"{% endif %}>
                <label class="switch-custom custom-control-label" for="show_messages">
                    {{ 'messages' | trans }}
                </label>
            </div>
            <div class="custom-control custom-switch mr-1">
                <input type="checkbox" id="show_requests"
                       name="search[show_options]"
                       class="show_options custom-control-input" value="1"
                       {% if showRequests %}checked="checked"{% endif %}>
                <label class="switch-custom custom-control-label" for="show_requests">
                    {{ 'requests' | trans }}
                </label>
            </div>
            <div class="custom-control custom-switch mr-1">
                <input type="checkbox" id="show_invitations"
                       name="search[show_options]"
                       class="show_options custom-control-input" value="1"
                       {% if showInvitations %}checked="checked"{% endif %}>
                <label class="switch-custom custom-control-label" for="show_invitations">
                    {{ 'invitations' | trans }}
                </label>
            </div>
            <div class="custom-control custom-switch mr-1">
                <input type="checkbox" id="show_unread_only"
                       name="search[show_options]"
                       class="show_options custom-control-input" value="1"
                       {% if showUnreadOnly %}checked="checked"{% endif %}>
                <label class="switch-custom custom-control-label" for="show_unread_only">
                    {{ 'unread.only' | trans }}
                </label>
            </div>
            <div class="custom-control custom-switch mr-1">
                <input type="checkbox" id="show_started_by_me"
                       name="search[show_options]"
                       class="show_options custom-control-input" value="1"
                       {% if showStartedByMe %}checked="checked"{% endif %}>
                <label class="switch-custom custom-control-label" for="show_started_by_me">
                    {{ 'started.by.me' | trans }}
                </label>
            </div>
            <div class="custom-control custom-switch mr-1">
                <input type="checkbox" id="show_started_by_someone_else"
                       name="search[show_options]"
                       class="show_options custom-control-input" value="1"
                       {% if showStartedBySomeoneElse %}checked="checked"{% endif %}>
                <label class="switch-custom custom-control-label" for="show_started_by_someone_else">
                    {{ 'started.by.someone.else' | trans }}
                </label>
            </div>
        </div>
    </div>
    {% if conversations.nbResults == 0 %}
        <p>{{ 'conversations.none' | trans }}</p>
    {% else %}
        {% if conversations.haveToPaginate %}
            <div class="float-right">
                {{ pagerfanta( conversations, 'rox_default') }}
            </div>
        {% endif %}

        {{ form_start(form) }}

        {% set correspondent %}receiver{% endset %}
        {% set _route = app.request.attributes.get('_route') %}

        <table class="table table-responsive table-striped table-hover">
            <tr>
                <th class="select align-middle">
                    <input type="checkbox" id="checkAll">
                </th>
                <th class="align-middle">{{ 'message.sent.by' | trans }}</th>
                <th class="align-middle">{{ 'messagestext' | trans }}</th>
                <th class="align-middle">{{ 'message.received.by' | trans }}</th>
                <th class="align-middle">&nbsp;</th>
            </tr>
            {% for message in conversations.currentPageResults %}
                {% set directionIn = (member.id == message.receiver.id) %}
                {% set otherMember = directionIn ? message.sender : message.receiver %}
                {% set unread = (message.firstRead is null) or (message.firstRead == '0000-00-00 00:00.00') %}
                {% set show_message_route = 'message_show' %}
                <tr>
                    <td class="select align-middle" id="selectcolumn">
                         {{ form_widget(form.messages[loop.index0], {'attr': {'class': 'checkable'}}) }}
                    </td>
                    <td class="align-middle small">
                        <p class="m-0">{{ macros.avatar(message.sender.Username, 50, true) }}</p>
                        <p class="m-0">{{ macros.profilelink(message.sender.Username) }}</p>
                    </td>
                    <td class="align-middle w-100">
                        <a href="{{ path(show_message_route, { id: message.id}) }}"
                            {%- if unread -%}
                                {{- ' class="unread"' -}}
                            {%- endif -%}
                        >
                            <div>
                                {% if message.subject %}<p class="m-0">
                                    <em>{% if message.parent %}Re: {% endif %}{{- message.subject.subject | striptags -}}</em>
                                    </p>{% endif %}
                                {% set messageText = message.Message | replace({'\n': ' ', '<br />': ' '}) | striptags %}

                                {% apply spaceless %}
                                    <p class="m-0 mb-1">{{- messageText | truncate(150) | raw -}}</p>
                                {% endapply %}
                                {% if message.request %}
                                    <div class="d-flex alert-light p-2">
                                        <div class="mr-2 font-weight-bold">
                                            <i class="fa fa-calendar mr-1"></i>{{ 'request.arrival' | trans }}
                                            {%- if message.request.departure %}<br>
                                                <i class="fa fa-calendar mr-1"></i>{{ 'request.departure' | trans }}{%- endif %}
                                        </div>
                                        <div>
                                            {{ message.request.arrival | format_date( 'medium') }}
                                            {%- if message.request.departure %}<br>
                                                {{ message.request.departure | format_date( 'medium') }}{%- endif %}
                                        </div>
                                    </div>
                                {% endif %}

                                <span class="text-muted small">{{ 'message.sentdate'|trans({'%sentDate%': message.dateSent | format_date( 'medium')}) }}</span>
                            </div>
                        </a>
                    </td>
                    <td class="align-middle small">
                        <p class="m-0">{{ macros.avatar(message.receiver.Username, 50, true) }}</p>
                        <p class="m-0">{{ macros.profilelink(message.receiver.Username) }}</p>
                    </td>
                    <td class="text-right">
                        <div class="btn-group-vertical">
                            <a href="{{ path(show_message_route, { id: message.id}) }}" class="btn btn-primary btn-sm">{{ 'view' | trans }}</a>
                            <a href="{{ path('message_reply', { id: message.id}) }}" class="btn btn-primary btn-sm">{{ 'reply' | trans }}</a>
                        </div>
                    </td>
                </tr>
            {% endfor %}
        </table>
        <tr>
            <td colspan="4">
                <div class="btn-group" aria-label="Delete or spam">
                    {{ form_widget(form.delete, { 'attr': { 'class': 'btn btn-danger'} }) }}
                    {{ form_widget(form.spam, { 'attr': { 'class': 'btn btn-light' } }) }}
                </div>
            </td>
        </tr>
        {{ form_rest(form) }}
        {{ form_end(form) }}
        {% if conversations.haveToPaginate %}
            <div class="float-right">
                {{ pagerfanta( conversations, 'rox_default') }}
            </div>
        {% endif %}

    {% endif %}
{% endblock %}
