{% extends 'trips.html.twig' %}
{% import 'macros.twig' as macros %}

{% block title %}
  {{ 'Trip' | trans }}
{% endblock %}

{% block stylesheets %}
  {{ encore_entry_link_tags('tailwind') }}
{% endblock %}

{% block content %}
  <section class="u-mb-48">
    <div class="u-mt-8 u-mb-24 u-inline-block">
      <div class="o-avatar o-avatar--white u-mr-24 u-float-left">{{ macros.roundedavatarstack(trip.creator.username, 96) }}</div>
      <div class="u-flex u-items-center u-h-96">
        <h1 class="u-text-32 u-leading-48 md:u-text-56 md:u-leading-60 u-text-white u-font-700">{{ trip.summary }}</h1>
        {% if app.user == trip.creator %}
          <a href="{{ path('trip_edit', {'id': trip.id}) }}" class="o-rounded u-ml-24" aria-label="{{ 'trip.edit'|trans }}" title="{{ 'trip.edit'|trans }}">
            <i class="fa fa-edit"></i>
          </a>
        {% endif %}
      </div>
    </div>
    <div class="l-trips-description">        
      <div class="u-flex u-mb-16">
        <div class="c-trip-card__icon-grid u-mr-24">
          <i class="fa fa-users u-text-white u-text-16 u-justify-self-center u-self-center u-text-gray-20"></i>
           <p class="u-text-white u-font-display" aria-label="{{ 'trip.count.of.travellers'|trans }}"><strong>{{ trip.countOfTravellers }}</strong> {{ 'trip.count.of.travellers'|trans }}</p>
        </div>
        <div class="c-trip-card__icon-grid">
          <i class="fa fa-info-circle u-text-white u-text-16 u-justify-self-center u-self-center u-text-gray-20"></i>
          <p class="u-text-white u-font-display" aria-label="{{ 'trip.additional.info'|trans }}">{{ trip.additionalInfo|trans }}</p>
        </div>
      </div>
      <p class="u-text-white u-font-display u-italic u-mb-24">{{ trip.description }}</p>
    </div>
    <div class="md:u-grid md:u-grid-cols-2 md:u-gap-24">     
      <div id="map" class="o-map"></div>
      <div class="l-trips-overlay-wrapper">         
        <ul>
          {% for subtrip in trip.subtrips %}
            <li class="l-trip-show">
              <span class="o-number o-number--white o-number--l u-relative u-ml-__18">{{ loop.index }}</span>
              <div>
                <div class="u-ml-16 md:u-ml-0 md:u-mt-4">
                  <p class="u-text-24 u-text-white u-font-display u-mb-8 u-font-300"><span class="u-font-500">{{ subtrip.location.name }}</span>, {{ subtrip.location.country.name }} <i class="o-flag o-flag--{{ subtrip.location.country.country }} u-ml-4"></i></p>
                  <p class="u-text-white u-font-display u-font-300">{{ subtrip.arrival|format_date('medium') }}{% if subtrip.arrival != subtrip.departure %} - {{ subtrip.departure|format_date('medium') }}{% endif%}</p>
                </div>

                <div class="u-ml-16 md:u-ml-0 md:u-mt-8">
                  {% if constant('App\\Doctrine\\SubtripOptionsType::MEET_LOCALS') in subtrip.options %}
                    <div class="c-trip-card__icon-grid u-mb-8">
                      <i class="fa fa-check u-text-white u-text-16 u-justify-self-center u-self-center u-text-green"></i>
                      <p class="u-text-white u-font-display" aria-label="{{ 'trip.option.meet.locals'|trans }}">{{ 'trip.option.meet.locals'|trans }}</p>
                    </div>
                  {% endif %}

                  {% if constant('App\\Doctrine\\SubtripOptionsType::LOOKING_FOR_HOST') in subtrip.options %}
                    <div class="c-trip-card__icon-grid">
                      <i class="fa fa-check u-text-white u-text-16 u-justify-self-center u-self-center u-text-green"></i>
                      <p class="u-text-white u-font-display" aria-label="{{ 'trip.option.meet.locals'|trans }}">{{ 'trip.option.looking.for.host'|trans }}</p>
                    </div>
                  {% endif %}
                </div>
              </div>

              <input type="hidden" class="js-data" value="{{ subtrip.location.name }}, {{ subtrip.location.latitude }}, {{ subtrip.location.longitude }},{{ subtrip.location.country.name }}, {{ subtrip.arrival|format_date('short') }}{% if subtrip.arrival != subtrip.departure %} - {{ subtrip.departure|format_date('short') }}{% endif%}">
            </li>
        {% endfor %}
        </ul>
      </div>
    </div>
  </section>

  <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js" 
          integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=" 
          crossorigin="anonymous"></script>

  <script src="https://unpkg.com/leaflet/dist/leaflet-src.js"></script>

  <script type="text/javascript">
    $(function () {
      if ($('#map').length) {

        var map = L.map('map', {
            center: [0, 0],
            zoom: 0,
            zoomSnap: 0.1
        });

        let allData = $('.js-data').map((_,el) => [el.value.split(',')]).get()

        let circlesArray = []

        let newCirclesArray = []

        for (let i = 0; i < allData.length; i++) {

          let location = allData[i][0]
          let latitude = allData[i][1]
          let longitude = allData[i][2]
          let countryName = allData[i][3]
          let tripDate = allData[i][4]

          let marker = L.marker([latitude, longitude]).addTo(map);
          marker.bindPopup("<strong>" + location + "</strong> (" + countryName + ")<br>" + tripDate).openPopup();

          let circle = L.circle([latitude, longitude], {
            color: 'rgb(112,0,243)',
            fillColor: 'rgba(112, 0, 243, 0.1)',
            fillOpacity: 1,
            radius: 100000
          }).addTo(map);

          console.log('circle', L.latLngBounds(circle))

          circlesArray.push(circle)
        }

        let group = new L.featureGroup(circlesArray);

        map.fitBounds(group.getBounds());



        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="/about/credits#OSM">OpenStreetMap contributors</a>',
          subdomains: ['a', 'b', 'c']
        }).addTo(map);
      }
    });
  </script>

{% endblock content %}

