<?php


class PageWithHTML extends AbstractBasePage
{
    private $_widgets = array();  // will be asked for stylesheet and scriptfile information

    public function render() {
        header('Content-type: text/html;charset="utf-8"');
        $this->printHTML();
        PVars::getObj('page')->output_done = true;
    }
    
    
    /**
     * don't forget to call
     * $stylesheets = parent::$this->getStylesheets();
     * when reimplementing this method!!
     */
    protected function getStylesheets()
    {
        $stylesheets = array();
        foreach ($this->_widgets as $widget) {
            foreach ($widget->getStylesheets() as $stylesheet) {
                $stylesheets[] = $stylesheet;
            }
        }
        return $stylesheets;
    }
    
    protected function getStylesheetPatches()
    {
        $stylesheet_patches = array();
        foreach ($this->_widgets as $widget) {
            foreach ($widget->getStylesheets() as $stylesheet_patches) {
                $stylesheet_patches[] = $stylesheet_patches;
            }
        }
        return $stylesheet_patches;
    }
    
    protected function getScriptfiles()
    {
        $scriptfiles = array(
            'script/main.js'
        );
        foreach ($this->_widgets as $widget) {
            foreach ($widget->getScriptfiles() as $scriptfile) {
                $scriptfiles[] = $scriptfile;
            }
        }
        return $scriptfiles;
    }
    
    protected function getPageTitle() {
        return 'BeWelcome';
    }
    
    
    /**
     * Widgets added this way will be asked
     * for stylesheet and scriptfile information
     * TODO: evtl not a good idea to do it this way.
     *
     * @param RoxWidget $widget
     */
    public function addWidget(RoxWidget $widget)
    {
        $this->_widgets[] = $widget;
    }
    
    
    protected function printHTML()
    {
        
        ?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="<?=PVars::get()->lang; ?>" lang="<?=PVars::get()->lang; ?>" xmlns:v="urn:schemas-microsoft-com:vml">
        <head>
        
        
        <!-- this page is generated by "class <?=get_class($this) ?>" -->
        <!-- the controller was an instance of <?=(is_string($this->controller_classname) ? ('"class '.$this->controller_classname.'"') : '[unknown class]') ?> -->
        <?=(is_object($this->layoutkit) && is_object($this->layoutkit->mem_from_redirect) ? '
        <!--
        '.$this->layoutkit->mem_from_redirect->buffered_text.'
        -->' : '') ?>
        
        
        
        <?php
        
        $this->head();
        $this->includeScriptfiles();
        ?>
        </head>
        <body>
        <?php
        
        echo (is_object($this->layoutkit) && (is_object($this->layoutkit->mem_from_redirect))) ? $this->layoutkit->mem_from_redirect->buffered_text : '';
        
        
        $this->body();
        
        ?>
        </body>
        </html><?php
    }
    
    
    protected function includeStylesheets()
    {
        if (!$stylesheets = $this->getStylesheets()) {
            // no stylesheets
        } else foreach($stylesheets as $url) {
            ?><link rel="stylesheet" href="<?=$url ?>" type="text/css" />
            <?php
        }
        if (!$stylesheet_patches = $this->getStylesheetPatches()) {
            // no stylesheets
        } else foreach($stylesheet_patches as $url) {
            ?>
    <!--[if lte IE 7]>
                    <link rel="stylesheet" href="<?=$url ?>" type="text/css" />
        <![endif]-->
            <?php
        }
    }
    
    protected function includeScriptfiles()
    {
        ?>

        <?php
        if (!$scriptfiles = $this->getScriptfiles()) {
            // no stylesheets
        } else foreach($scriptfiles as $url) {
            ?><script type="text/javascript" src="<?=$url ?>"></script>
            <?php
        }
    }
    
    protected function head()
    {
        ?>
        <title><?=$this->getPageTitle() ?></title>
        <base id="baseuri" href="<?=PVars::getObj('env')->baseuri; ?>" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="verify-v1" content="NzxSlKbYK+CRnCfULeWj0RaPCGNIuPqq10oUpGAEyWw=" />
        
        <?php
        $this->includeStylesheets();
        ?>
    
        <?php
        $this->_tr_buffer_header = $this->getWords()->flushBuffer();
    }
    
    protected function getPagePermalink() {
        return 'index';
    }
}


?>
